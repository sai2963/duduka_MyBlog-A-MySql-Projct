<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Post Details</title>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous"
    />
</head>
<body>
    <nav class="navbar bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand">My Blog</a>
            <form class="d-flex" role="search">
                <button class="btn btn-outline-success" type="menu">
                    <a href="post-list.html">All Posts</a>
                </button>
                <button class="btn btn-outline-success" type="button">
                    <a href="create-post.html">Create Posts</a>
                </button>
            </form>
        </div>
    </nav>

    <div class="container mt-4">
        <h4>Post Details</h4>
        <div id="postDetails"></div>
        <button class="btn btn-primary mt-3" id="editButton">Edit</button>
        <div id="editForm" style="display: none;">
            <form id="editPostForm">
                <div class="form-group">
                    <label for="editTitle">Title</label>
                    <input
                        type="text"
                        class="form-control"
                        id="editTitle"
                        name="title"
                    />
                </div>
                <div class="form-group">
                    <label for="editSummary">Summary</label>
                    <input
                        type="text"
                        class="form-control"
                        id="editSummary"
                        name="summary"
                    />
                </div>
                <div class="form-group">
                    <label for="editComments">Comments</label>
                    <textarea
                        class="form-control"
                        id="editComments"
                        rows="3"
                        name="comments"
                    ></textarea>
                </div>
                <div class="form-group">
                    <label>Author</label><br>
                    <!-- Assuming authorsData is available -->
                    <div id="editAuthorRadio"></div>
                </div>
                <button type="button" class="btn btn-primary" onclick="saveChanges()">Save Changes</button>
            </form>
        </div>
    </div>

    <script>
        let postId; // Declare postId outside the DOMContentLoaded event listener

        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            postId = urlParams.get("id"); // Assign the value to postId

            const postDetailsContainer = document.getElementById("postDetails");
            const editButton = document.getElementById("editButton");
            const editForm = document.getElementById("editForm");
            const editTitleInput = document.getElementById("editTitle");
            const editSummaryInput = document.getElementById("editSummary");
            const editCommentsInput = document.getElementById("editComments");
            const editAuthorRadioContainer = document.getElementById("editAuthorRadio");

            fetch(`/post-details?id=${postId}`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(
                            `Failed to fetch post details: ${response.status} ${response.statusText}`
                        );
                    }
                    return response.json();
                })
                .then((postDetails) => {
                    postDetailsContainer.innerHTML = `
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title" id="postTitle">${postDetails.Title}</h5>
                                <p class="card-text" id="postSummary">${postDetails.Summary}</p>
                                <p class="card-text" id="postBody">${postDetails.Body}</p>
                                <p class="card-text">Author: ${postDetails.author_name}</p>
                            </div>
                        </div>
                    `;

                    // Set initial values for the edit form
                    editTitleInput.value = postDetails.Title;
                    editSummaryInput.value = postDetails.Summary;
                    editCommentsInput.value = postDetails.Body;

                    // Add radio buttons for authors
                    fetch("/create-post") // Replace with the correct endpoint
                        .then((response) => response.json())
                        .then((authorsData) => {
                            authorsData.forEach(function (author) {
                                var radioInput = document.createElement("input");
                                radioInput.type = "radio";
                                radioInput.name = "editAuthor";
                                radioInput.value = author.id;
                                radioInput.id = `editAuthor_${author.id}`;

                                var label = document.createElement("label");
                                label.htmlFor = `editAuthor_${author.id}`;
                                label.appendChild(document.createTextNode(author.name));

                                editAuthorRadioContainer.appendChild(radioInput);
                                editAuthorRadioContainer.appendChild(label);

                                // Set initial value based on the post's author
                                if (postDetails.author_id === author.id) {
                                    radioInput.checked = true;
                                }
                            });
                        })
                        .catch((error) => console.error("Error fetching authors:", error));
                })
                .catch((error) => {
                    console.error("Error fetching post details:", error);
                    alert("Error fetching post details. Please try again later.");
                });

            editButton.addEventListener("click", function () {
                // Toggle visibility of the edit form
                editForm.style.display = editForm.style.display === "none" ? "block" : "none";
            });
        });

        // ... (other parts of the script)

        function saveChanges() {
    // Get values from the edit form
    const editedTitle = document.getElementById("editTitle").value;
    const editedSummary = document.getElementById("editSummary").value;
    const editedComments = document.getElementById("editComments").value;
    const editedAuthorId = document.querySelector('input[name="editAuthor"]:checked').value;

    // Check if title is not empty
    if (!editedTitle.trim()) {
        alert("Title cannot be empty");
        return;
    }

    // Make a PUT request to update the post details
    fetch(`/post-list/${postId}`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            title: editedTitle,
            summary: editedSummary,
            comments: editedComments,
            author: editedAuthorId,
        }),
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to update post details: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(updatedPost => {
            // Update the displayed post details
            document.getElementById("postTitle").innerText = updatedPost.title;
            document.getElementById("postSummary").innerText = updatedPost.summary;
            document.getElementById("postBody").innerText = updatedPost.body;
            document.querySelector('.card-text').innerText = `Author: ${updatedPost.author_name}`;

            // Hide the edit form
            document.getElementById("editForm").style.display = "none";
        })
        .catch((error) => console.error("Error updating post details:", error));
}


    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
</body>
</html>
